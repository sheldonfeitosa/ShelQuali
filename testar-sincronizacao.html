<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Sincroniza√ß√£o - Qualishel</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #4CAF50;
            padding-bottom: 10px;
        }
        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 10px 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 5px;
        }
        .log {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
        }
        .log-success { color: #4ec9b0; }
        .log-error { color: #f48771; }
        .log-info { color: #569cd6; }
        .log-warning { color: #dcdcaa; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Teste de Sincroniza√ß√£o Firebase</h1>
        
        <div id="status-container"></div>
        
        <div class="test-section">
            <h2>1. Verifica√ß√£o Inicial</h2>
            <button onclick="testFirebaseInit()">Testar Inicializa√ß√£o do Firebase</button>
            <div id="init-status"></div>
        </div>
        
        <div class="test-section">
            <h2>2. Teste de Leitura/Escrita</h2>
            <button onclick="testReadWrite()">Testar Leitura/Escrita</button>
            <div id="readwrite-status"></div>
        </div>
        
        <div class="test-section">
            <h2>3. Teste de Sincroniza√ß√£o em Tempo Real</h2>
            <button onclick="testRealtimeSync()">Iniciar Teste de Tempo Real</button>
            <button onclick="stopRealtimeSync()" id="stop-btn" disabled>Parar Teste</button>
            <div id="realtime-status"></div>
        </div>
        
        <div class="test-section">
            <h2>4. Teste Completo de Sincroniza√ß√£o</h2>
            <p><strong>Instru√ß√µes:</strong></p>
            <ol>
                <li>Abra esta p√°gina em <strong>2 abas diferentes</strong> do navegador</li>
                <li>Clique em "Iniciar Teste Completo" em ambas as abas</li>
                <li>Na aba 1, clique em "Enviar Dados de Teste"</li>
                <li>Observe se os dados aparecem automaticamente na aba 2</li>
            </ol>
            <button onclick="startFullTest()">Iniciar Teste Completo</button>
            <button onclick="sendTestData()" id="send-btn" disabled>Enviar Dados de Teste</button>
            <div id="fulltest-status"></div>
        </div>
        
        <div class="test-section">
            <h2>üìã Log de Eventos</h2>
            <button onclick="clearLog()">Limpar Log</button>
            <div id="log" class="log"></div>
        </div>
    </div>

    <!-- Firebase Config -->
    <script type="module" src="firebase-config.js"></script>
    <!-- Firebase Service -->
    <script src="firebase-service.js"></script>

    <script>
        let realtimeListenerActive = false;
        let fullTestActive = false;
        let testListener = null;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        function showStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        // Teste 1: Verificar inicializa√ß√£o do Firebase
        async function testFirebaseInit() {
            log('üîç Testando inicializa√ß√£o do Firebase...', 'info');
            
            // Aguardar um pouco para o Firebase carregar
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // Verificar se window.db existe
            const dbExists = typeof window.db !== 'undefined' && window.db !== null;
            log(`window.db existe: ${dbExists}`, dbExists ? 'success' : 'error');
            
            // Verificar se firebaseService existe e est√° inicializado
            const serviceExists = typeof window.firebaseService !== 'undefined';
            log(`firebaseService existe: ${serviceExists}`, serviceExists ? 'success' : 'warning');
            
            let isInitialized = false;
            if (serviceExists) {
                isInitialized = window.firebaseService.isInitialized();
                log(`firebaseService.isInitialized(): ${isInitialized}`, isInitialized ? 'success' : 'error');
            }
            
            // Verificar API Key
            if (dbExists) {
                try {
                    // Tentar verificar se h√° erro de API Key
                    const configScript = document.querySelector('script[src="firebase-config.js"]');
                    if (configScript) {
                        fetch('firebase-config.js')
                            .then(response => response.text())
                            .then(text => {
                                if (text.includes('AIzaSyC...') || text.match(/apiKey:\s*"[^"]*\.\.\.[^"]*"/)) {
                                    log('‚ö†Ô∏è API Key incompleta detectada no arquivo!', 'warning');
                                }
                            });
                    }
                } catch (e) {
                    // Ignorar erros de verifica√ß√£o
                }
            }
            
            if (dbExists && (isInitialized || serviceExists)) {
                showStatus('init-status', 
                    '‚úÖ Firebase inicializado com sucesso!<br>' +
                    '‚úÖ window.db: OK<br>' +
                    '‚úÖ firebaseService: ' + (isInitialized ? 'Inicializado' : 'Dispon√≠vel'), 
                    'success');
                log('‚úÖ Firebase est√° inicializado e pronto', 'success');
                return true;
            } else {
                let errorMsg = '‚ùå Firebase n√£o est√° inicializado.<br>';
                if (!dbExists) {
                    errorMsg += '‚ùå window.db n√£o encontrado<br>';
                    errorMsg += '‚ö†Ô∏è Verifique se firebase-config.js est√° carregado e a API Key est√° completa';
                } else if (!serviceExists) {
                    errorMsg += '‚ö†Ô∏è firebaseService n√£o encontrado';
                } else {
                    errorMsg += '‚ö†Ô∏è Firebase n√£o inicializado corretamente';
                }
                
                showStatus('init-status', errorMsg, 'error');
                log('‚ùå Firebase n√£o est√° inicializado', 'error');
                log('üí° Dica: Verifique se a API Key no firebase-config.js est√° completa (n√£o pode ter "...")', 'warning');
                return false;
            }
        }

        // Teste 2: Testar leitura/escrita
        async function testReadWrite() {
            log('üîç Testando leitura/escrita no Firestore...', 'info');
            
            if (!window.firebaseService || !window.firebaseService.isInitialized()) {
                showStatus('readwrite-status', '‚ùå Firebase n√£o inicializado. Execute o teste 1 primeiro.', 'error');
                return;
            }

            try {
                // Teste de escrita
                const testData = {
                    demands: [{ id: 999, text: 'Teste de sincroniza√ß√£o', timestamp: new Date().toISOString() }],
                    counter: 999
                };
                
                log('üìù Escrevendo dados de teste...', 'info');
                await window.firebaseService.saveDemandsToStorage(testData.demands, testData.counter);
                log('‚úÖ Dados escritos com sucesso', 'success');
                
                // Aguardar um pouco
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Teste de leitura
                log('üìñ Lendo dados do Firestore...', 'info');
                const loaded = await window.firebaseService.loadDemandsFromStorage();
                
                if (loaded && loaded.demands && loaded.demands.length > 0) {
                    const found = loaded.demands.find(d => d.id === 999);
                    if (found) {
                        showStatus('readwrite-status', '‚úÖ Leitura e escrita funcionando corretamente!', 'success');
                        log('‚úÖ Dados lidos com sucesso: ' + JSON.stringify(loaded), 'success');
                    } else {
                        showStatus('readwrite-status', '‚ö†Ô∏è Dados escritos mas n√£o encontrados na leitura', 'warning');
                        log('‚ö†Ô∏è Dados n√£o encontrados na leitura', 'warning');
                    }
                } else {
                    showStatus('readwrite-status', '‚ö†Ô∏è Leitura retornou dados vazios', 'warning');
                    log('‚ö†Ô∏è Dados vazios na leitura', 'warning');
                }
            } catch (error) {
                showStatus('readwrite-status', '‚ùå Erro ao testar leitura/escrita: ' + error.message, 'error');
                log('‚ùå Erro: ' + error.message, 'error');
            }
        }

        // Teste 3: Sincroniza√ß√£o em tempo real
        async function testRealtimeSync() {
            log('üîÑ Iniciando teste de sincroniza√ß√£o em tempo real...', 'info');
            
            if (!window.firebaseService || !window.firebaseService.isInitialized()) {
                showStatus('realtime-status', '‚ùå Firebase n√£o inicializado', 'error');
                return;
            }

            try {
                realtimeListenerActive = true;
                document.getElementById('stop-btn').disabled = false;
                
                await window.firebaseService.setupRealtimeDemandsListener((data) => {
                    log('üîÑ Atualiza√ß√£o recebida em tempo real!', 'success');
                    log('Dados: ' + JSON.stringify(data), 'info');
                    showStatus('realtime-status', 
                        `‚úÖ Listener ativo! Demandas: ${data.demands.length}, Counter: ${data.counter}`, 
                        'success');
                });
                
                showStatus('realtime-status', '‚úÖ Listener configurado. Aguardando atualiza√ß√µes...', 'info');
                log('‚úÖ Listener de tempo real configurado', 'success');
            } catch (error) {
                showStatus('realtime-status', '‚ùå Erro ao configurar listener: ' + error.message, 'error');
                log('‚ùå Erro: ' + error.message, 'error');
            }
        }

        function stopRealtimeSync() {
            if (window.firebaseService && window.firebaseService.removeAllListeners) {
                window.firebaseService.removeAllListeners();
                realtimeListenerActive = false;
                document.getElementById('stop-btn').disabled = true;
                showStatus('realtime-status', '‚èπÔ∏è Listener parado', 'info');
                log('‚èπÔ∏è Listener parado', 'info');
            }
        }

        // Teste 4: Teste completo de sincroniza√ß√£o
        async function startFullTest() {
            log('üöÄ Iniciando teste completo de sincroniza√ß√£o...', 'info');
            
            if (!window.firebaseService || !window.firebaseService.isInitialized()) {
                showStatus('fulltest-status', '‚ùå Firebase n√£o inicializado', 'error');
                return;
            }

            fullTestActive = true;
            document.getElementById('send-btn').disabled = false;
            
            // Configurar listener
            await window.firebaseService.setupRealtimeDemandsListener((data) => {
                log('üîÑ Sincroniza√ß√£o detectada! Dados atualizados automaticamente.', 'success');
                showStatus('fulltest-status', 
                    `‚úÖ Sincroniza√ß√£o funcionando! Recebido: ${data.demands.length} demandas`, 
                    'success');
            });
            
            showStatus('fulltest-status', 
                '‚úÖ Teste iniciado! Abra esta p√°gina em outra aba e clique em "Enviar Dados de Teste"', 
                'info');
            log('‚úÖ Teste completo iniciado. Aguardando dados de outra aba...', 'info');
        }

        async function sendTestData() {
            if (!fullTestActive) {
                alert('Inicie o teste completo primeiro!');
                return;
            }

            log('üì§ Enviando dados de teste...', 'info');
            
            const testData = {
                id: Date.now(),
                text: `Teste de sincroniza√ß√£o - ${new Date().toLocaleTimeString()}`,
                timestamp: new Date().toISOString()
            };
            
            try {
                // Carregar demandas existentes
                const current = await window.firebaseService.loadDemandsFromStorage();
                const demands = current.demands || [];
                demands.push(testData);
                
                // Salvar
                await window.firebaseService.saveDemandsToStorage(demands, current.counter || 1);
                
                log('‚úÖ Dados enviados! Verifique a outra aba.', 'success');
                showStatus('fulltest-status', 
                    '‚úÖ Dados enviados! Se a sincroniza√ß√£o estiver funcionando, os dados aparecer√£o automaticamente na outra aba em alguns segundos.', 
                    'success');
            } catch (error) {
                log('‚ùå Erro ao enviar dados: ' + error.message, 'error');
                showStatus('fulltest-status', '‚ùå Erro ao enviar dados: ' + error.message, 'error');
            }
        }

        // Verificar API Key
        function checkApiKey() {
            const script = document.querySelector('script[src="firebase-config.js"]');
            if (!script) {
                log('‚ùå Arquivo firebase-config.js n√£o encontrado', 'error');
                return false;
            }
            
            // Tentar verificar se a API Key est√° completa
            fetch('firebase-config.js')
                .then(response => response.text())
                .then(text => {
                    const apiKeyMatch = text.match(/apiKey:\s*"([^"]+)"/);
                    if (apiKeyMatch) {
                        const apiKey = apiKeyMatch[1];
                        if (apiKey.includes('...') || apiKey.length < 30) {
                            log('‚ö†Ô∏è API Key incompleta detectada!', 'warning');
                            showStatus('status-container', 
                                '‚ö†Ô∏è API Key incompleta no firebase-config.js!<br>' +
                                'üìã <strong>Como corrigir:</strong><br>' +
                                '1. Acesse: <a href="https://console.firebase.google.com/" target="_blank">Firebase Console</a><br>' +
                                '2. Projeto: qualisheldon ‚Üí Configura√ß√µes (‚öôÔ∏è)<br>' +
                                '3. Role at√© "Seus aplicativos" ‚Üí Web (`</>`)<br>' +
                                '4. Copie a API Key COMPLETA (cerca de 39 caracteres)<br>' +
                                '5. Cole no arquivo firebase-config.js substituindo "AIzaSyC..."<br>' +
                                '6. Recarregue esta p√°gina (F5)', 
                                'warning');
                        }
                    }
                })
                .catch(error => {
                    log('‚ö†Ô∏è N√£o foi poss√≠vel verificar firebase-config.js: ' + error.message, 'warning');
                });
            
            return true;
        }

        // Status inicial
        window.addEventListener('DOMContentLoaded', async () => {
            log('üìã P√°gina carregada. Aguardando inicializa√ß√£o do Firebase...', 'info');
            
            // Verificar API Key
            checkApiKey();
            
            // Aguardar Firebase inicializar
            setTimeout(async () => {
                const initialized = await testFirebaseInit();
                if (initialized) {
                    showStatus('status-container', 
                        '‚úÖ Sistema pronto para testes! Execute os testes abaixo.', 
                        'success');
                } else {
                    showStatus('status-container', 
                        '‚ö†Ô∏è Firebase n√£o inicializado.<br>' +
                        '<strong>Problema comum:</strong> API Key incompleta no firebase-config.js<br>' +
                        'üìã <strong>Solu√ß√£o:</strong> Complete a API Key (veja instru√ß√µes acima) e recarregue a p√°gina (F5)', 
                        'warning');
                }
            }, 2000);
        });
    </script>
</body>
</html>

